name: CI/CD DevOps Mini

on:
  push:
    branches: [ main ]
    paths:
      - "03_app/**"
      - ".github/workflows/ci-cd.yml"

jobs:
  trivy-scan:
    name: ðŸ” Trivy Scan Image
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag for scan
        run: |
          echo "IMG=flask-demo:test" >> $GITHUB_ENV

      - name: Build image for Trivy scan
        run: docker build -t $IMG ./03_app

      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@v0.19.0
        with:
          image-ref: ${{ env.IMG }}
          format: table
          severity: CRITICAL,HIGH
          exit-code: 1     # ðŸ”¥ Fail náº¿u cÃ³ lá»—i

  build-deploy:
    name: ðŸš€ Build & Deploy to K3s
    runs-on: self-hosted
    needs: trivy-scan

    steps:
      - uses: actions/checkout@v4

      - name: Compose image tag
        run: |
          echo "IMAGE_REPO=${{ secrets.DOCKERHUB_USER }}/flask-demo" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV
          echo "IMAGE_FULL=${{ secrets.DOCKERHUB_USER }}/flask-demo:${{ github.sha }}" >> $GITHUB_ENV

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & push image
        uses: docker/build-push-action@v5
        with:
          context: ./03_app
          push: true
          tags: ${{ env.IMAGE_FULL }}

      - name: Set kubeconfig
        run: echo "${{ secrets.KUBE_CONFIG_B64 }}" | base64 -d > $HOME/.kube/config

      - name: Deploy to K3s
        run: |
          kubectl set image deployment/flask-deploy flask-container=${{ env.IMAGE_FULL }} -n default
          kubectl rollout status deployment/flask-deploy -n default
